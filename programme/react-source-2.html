<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Fiber Scheduler | sys-doc</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/sys-doc/assets/css/0.styles.f2c13968.css" as="style"><link rel="preload" href="/sys-doc/assets/js/app.f52ec2a5.js" as="script"><link rel="preload" href="/sys-doc/assets/js/2.01d9652a.js" as="script"><link rel="preload" href="/sys-doc/assets/js/67.7c75e618.js" as="script"><link rel="prefetch" href="/sys-doc/assets/js/10.331427a7.js"><link rel="prefetch" href="/sys-doc/assets/js/11.89b28dfb.js"><link rel="prefetch" href="/sys-doc/assets/js/12.7136e253.js"><link rel="prefetch" href="/sys-doc/assets/js/13.a1feb60a.js"><link rel="prefetch" href="/sys-doc/assets/js/14.b0c7cf4d.js"><link rel="prefetch" href="/sys-doc/assets/js/15.e9dadc97.js"><link rel="prefetch" href="/sys-doc/assets/js/16.edc12257.js"><link rel="prefetch" href="/sys-doc/assets/js/17.13d64156.js"><link rel="prefetch" href="/sys-doc/assets/js/18.61d35156.js"><link rel="prefetch" href="/sys-doc/assets/js/19.05bd98c3.js"><link rel="prefetch" href="/sys-doc/assets/js/20.b76e3b5f.js"><link rel="prefetch" href="/sys-doc/assets/js/21.a908efea.js"><link rel="prefetch" href="/sys-doc/assets/js/22.48cb9c16.js"><link rel="prefetch" href="/sys-doc/assets/js/23.0c180cf1.js"><link rel="prefetch" href="/sys-doc/assets/js/24.77e09a3e.js"><link rel="prefetch" href="/sys-doc/assets/js/25.e55672d9.js"><link rel="prefetch" href="/sys-doc/assets/js/26.e11de8a1.js"><link rel="prefetch" href="/sys-doc/assets/js/27.e81e4d27.js"><link rel="prefetch" href="/sys-doc/assets/js/28.d0c23cdc.js"><link rel="prefetch" href="/sys-doc/assets/js/29.3331415c.js"><link rel="prefetch" href="/sys-doc/assets/js/3.2b33e907.js"><link rel="prefetch" href="/sys-doc/assets/js/30.18bddb07.js"><link rel="prefetch" href="/sys-doc/assets/js/31.0c0fc3f6.js"><link rel="prefetch" href="/sys-doc/assets/js/32.060f8c40.js"><link rel="prefetch" href="/sys-doc/assets/js/33.f18bbd6f.js"><link rel="prefetch" href="/sys-doc/assets/js/34.4dd36a20.js"><link rel="prefetch" href="/sys-doc/assets/js/35.89762187.js"><link rel="prefetch" href="/sys-doc/assets/js/36.522cc1a5.js"><link rel="prefetch" href="/sys-doc/assets/js/37.dfbffb38.js"><link rel="prefetch" href="/sys-doc/assets/js/38.cf3be4f4.js"><link rel="prefetch" href="/sys-doc/assets/js/39.5e3f13bc.js"><link rel="prefetch" href="/sys-doc/assets/js/4.ba3164ba.js"><link rel="prefetch" href="/sys-doc/assets/js/40.4c6aa0e8.js"><link rel="prefetch" href="/sys-doc/assets/js/41.54caa505.js"><link rel="prefetch" href="/sys-doc/assets/js/42.ec5daa0a.js"><link rel="prefetch" href="/sys-doc/assets/js/43.d9177c9c.js"><link rel="prefetch" href="/sys-doc/assets/js/44.7813468c.js"><link rel="prefetch" href="/sys-doc/assets/js/45.5b04c343.js"><link rel="prefetch" href="/sys-doc/assets/js/46.d28fed93.js"><link rel="prefetch" href="/sys-doc/assets/js/47.34b311fa.js"><link rel="prefetch" href="/sys-doc/assets/js/48.74076f81.js"><link rel="prefetch" href="/sys-doc/assets/js/49.4007bf78.js"><link rel="prefetch" href="/sys-doc/assets/js/5.75a3592b.js"><link rel="prefetch" href="/sys-doc/assets/js/50.20021ec4.js"><link rel="prefetch" href="/sys-doc/assets/js/51.950d1096.js"><link rel="prefetch" href="/sys-doc/assets/js/52.c8cd6177.js"><link rel="prefetch" href="/sys-doc/assets/js/53.d80f960d.js"><link rel="prefetch" href="/sys-doc/assets/js/54.56b9ae8f.js"><link rel="prefetch" href="/sys-doc/assets/js/55.11dd75dc.js"><link rel="prefetch" href="/sys-doc/assets/js/56.30b21a2e.js"><link rel="prefetch" href="/sys-doc/assets/js/57.7a7687c5.js"><link rel="prefetch" href="/sys-doc/assets/js/58.17b24726.js"><link rel="prefetch" href="/sys-doc/assets/js/59.8717a233.js"><link rel="prefetch" href="/sys-doc/assets/js/6.0377ba0c.js"><link rel="prefetch" href="/sys-doc/assets/js/60.cf7867c5.js"><link rel="prefetch" href="/sys-doc/assets/js/61.a27fb1f3.js"><link rel="prefetch" href="/sys-doc/assets/js/62.1c7b9e02.js"><link rel="prefetch" href="/sys-doc/assets/js/63.d63530cf.js"><link rel="prefetch" href="/sys-doc/assets/js/64.c77d7e5f.js"><link rel="prefetch" href="/sys-doc/assets/js/65.c37a5abd.js"><link rel="prefetch" href="/sys-doc/assets/js/66.d15efb7a.js"><link rel="prefetch" href="/sys-doc/assets/js/68.12e0c03d.js"><link rel="prefetch" href="/sys-doc/assets/js/69.39e488c5.js"><link rel="prefetch" href="/sys-doc/assets/js/7.dc078c9b.js"><link rel="prefetch" href="/sys-doc/assets/js/70.3e64db6a.js"><link rel="prefetch" href="/sys-doc/assets/js/71.9733a685.js"><link rel="prefetch" href="/sys-doc/assets/js/72.8d4415e1.js"><link rel="prefetch" href="/sys-doc/assets/js/73.a1d9b05d.js"><link rel="prefetch" href="/sys-doc/assets/js/74.59b5b15a.js"><link rel="prefetch" href="/sys-doc/assets/js/75.baf5b699.js"><link rel="prefetch" href="/sys-doc/assets/js/76.2a3eb9c5.js"><link rel="prefetch" href="/sys-doc/assets/js/77.14a997bb.js"><link rel="prefetch" href="/sys-doc/assets/js/78.e03a28df.js"><link rel="prefetch" href="/sys-doc/assets/js/8.ada5e17a.js"><link rel="prefetch" href="/sys-doc/assets/js/9.8f775d5a.js">
    <link rel="stylesheet" href="/sys-doc/assets/css/0.styles.f2c13968.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/sys-doc/" class="home-link router-link-active"><img src="/sys-doc/imgs/logo.jpeg" alt="sys-doc" class="logo"> <span class="site-name can-hide">sys-doc</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/sys-doc/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/sys-doc/programme/" class="nav-link router-link-active">
  编程
</a></div><div class="nav-item"><a href="/sys-doc/engineer/" class="nav-link">
  工程
</a></div><div class="nav-item"><a href="/sys-doc/framework/" class="nav-link">
  架构
</a></div><div class="nav-item"><a href="/sys-doc/shell/" class="nav-link">
  集锦
</a></div><div class="nav-item"><a href="/sys-doc/leetCode/" class="nav-link">
  LCode
</a></div> <a href="https://github.com/chttyCode/sys-doc" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/sys-doc/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/sys-doc/programme/" class="nav-link router-link-active">
  编程
</a></div><div class="nav-item"><a href="/sys-doc/engineer/" class="nav-link">
  工程
</a></div><div class="nav-item"><a href="/sys-doc/framework/" class="nav-link">
  架构
</a></div><div class="nav-item"><a href="/sys-doc/shell/" class="nav-link">
  集锦
</a></div><div class="nav-item"><a href="/sys-doc/leetCode/" class="nav-link">
  LCode
</a></div> <a href="https://github.com/chttyCode/sys-doc" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/sys-doc/programme/" aria-current="page" class="sidebar-link">编程</a></li><li><a href="/sys-doc/programme/git.html" class="sidebar-link">git</a></li><li><a href="/sys-doc/programme/vscode.html" class="sidebar-link">vscode</a></li><li><a href="/sys-doc/programme/typescript.html" class="sidebar-link">Typescript</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/sys-doc/programme/mini-program.html" class="sidebar-link">小程序</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>nodejs</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>react</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/sys-doc/programme/react.html" class="sidebar-link">React</a></li><li><a href="/sys-doc/programme/react-statue.html" class="sidebar-link">redux</a></li><li><a href="/sys-doc/programme/react-toolkit.html" class="sidebar-link">toolkit</a></li><li><a href="/sys-doc/programme/react-recoil.html" class="sidebar-link">recoil</a></li><li><a href="/sys-doc/programme/react-hooks.html" class="sidebar-link">hooks</a></li><li><a href="/sys-doc/programme/react-context.html" class="sidebar-link">context</a></li><li><a href="/sys-doc/programme/react-simple.html" class="sidebar-link">react简码</a></li><li><a href="/sys-doc/programme/react-recommend.html" class="sidebar-link">react开发范式</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>源码解读</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/sys-doc/programme/react-source.html" class="sidebar-link">React 源码阅读</a></li><li><a href="/sys-doc/programme/react-source-1.html" class="sidebar-link">React 中的更新</a></li><li><a href="/sys-doc/programme/react-source-2.html" aria-current="page" class="active sidebar-link">Fiber Scheduler</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/sys-doc/programme/react-source-2.html#fiber-scheduler" class="sidebar-link">Fiber Scheduler</a></li></ul></li><li><a href="/sys-doc/programme/react-source-3.html" class="sidebar-link">各类组件 update</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="fiber-scheduler"><a href="#fiber-scheduler" class="header-anchor">#</a> Fiber Scheduler</h2> <ul><li><p>scheduleWork</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">scheduleWork</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">,</span> expirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> root <span class="token operator">=</span> <span class="token function">scheduleWorkToRoot</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token operator">!</span>isWorking <span class="token operator">&amp;&amp;</span>
    nextRenderExpirationTime <span class="token operator">!==</span> NoWork <span class="token operator">&amp;&amp;</span>
    expirationTime <span class="token operator">&lt;</span> nextRenderExpirationTime
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This is an interruption. (Used for performance tracking.)</span>
    interruptedBy <span class="token operator">=</span> fiber<span class="token punctuation">;</span>
    <span class="token function">resetStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">markPendingPriorityLevel</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token comment">// If we're in the render phase, we don't need to schedule this root</span>
    <span class="token comment">// for an update, because we'll do it before we exit...</span>
    <span class="token operator">!</span>isWorking <span class="token operator">||</span>
    isCommitting$<span class="token number">1</span> <span class="token operator">||</span> <span class="token comment">// ...unless this is a different root than the one we're rendering.</span>
    nextRoot <span class="token operator">!==</span> root
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> rootExpirationTime <span class="token operator">=</span> root<span class="token punctuation">.</span>expirationTime<span class="token punctuation">;</span>
    <span class="token function">requestWork</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> rootExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p>调用 scheduleWorkToRoot 目的</p> <ul><li><p>找到当前 Fiber 的 root</p></li> <li><p>给更新节点的父节点链上的每个节点的 expirationTime 设置为这个 update 的 expirationTime，除非他本身时间要小于 expirationTime</p></li> <li><p>给更新节点的父节点链上的每个节点的 childExpirationTime 设置为这个 update 的 expirationTime，除非他本身时间要小于 expirationTime</p></li> <li><p>最终返回 root 节点的 Fiber 对象即 fiberRoot</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">scheduleWorkToRoot</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">,</span> expirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Update the source fiber's expiration time</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>expirationTime <span class="token operator">===</span> NoWork <span class="token operator">||</span> fiber<span class="token punctuation">.</span>expirationTime <span class="token operator">&gt;</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fiber<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> alternate <span class="token operator">=</span> fiber<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>alternate <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>alternate<span class="token punctuation">.</span>expirationTime <span class="token operator">===</span> NoWork <span class="token operator">||</span> alternate<span class="token punctuation">.</span>expirationTime <span class="token operator">&gt;</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    alternate<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token comment">// Walk the parent path to the root and update the child expiration time.</span>

  <span class="token keyword">var</span> node <span class="token operator">=</span> fiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
  <span class="token keyword">var</span> root <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> fiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    root <span class="token operator">=</span> fiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>node <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      alternate <span class="token operator">=</span> node<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>childExpirationTime <span class="token operator">===</span> NoWork <span class="token operator">||</span> node<span class="token punctuation">.</span>childExpirationTime <span class="token operator">&gt;</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        node<span class="token punctuation">.</span>childExpirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          alternate <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
          <span class="token punctuation">(</span>alternate<span class="token punctuation">.</span>childExpirationTime <span class="token operator">===</span> NoWork <span class="token operator">||</span> alternate<span class="token punctuation">.</span>childExpirationTime <span class="token operator">&gt;</span> expirationTime<span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          alternate<span class="token punctuation">.</span>childExpirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
        alternate <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>alternate<span class="token punctuation">.</span>childExpirationTime <span class="token operator">===</span> NoWork <span class="token operator">||</span> alternate<span class="token punctuation">.</span>childExpirationTime <span class="token operator">&gt;</span> expirationTime<span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        alternate<span class="token punctuation">.</span>childExpirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>return <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        root <span class="token operator">=</span> node<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      node <span class="token operator">=</span> node<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> root<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></li> <li><p>判断是否有任务被打断，如果有需要将其重置</p></li> <li><p>更新各种 expirationTime</p></li> <li><p>如果是 !isWorking || isCommitting 开始调用 requestWork</p></li></ul></li> <li><p>requestWork</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">requestWork</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span> expirationTime<span class="token operator">:</span> ExpirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">addRootToSchedule</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isRendering<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Prevent reentrancy. Remaining work will be scheduled at the end of</span>
    <span class="token comment">// the currently rendering batch.</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isBatchingUpdates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Flush work at the end of the batch.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isUnbatchingUpdates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      nextFlushedRoot <span class="token operator">=</span> root<span class="token punctuation">;</span>
      nextFlushedExpirationTime <span class="token operator">=</span> Sync<span class="token punctuation">;</span>
      <span class="token function">performWorkOnRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> Sync<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>expirationTime <span class="token operator">===</span> Sync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">performSyncWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">scheduleCallbackWithExpirationTime</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p>addRootToSchedule 把 root 加入到调度队列，但是要注意一点，不会存在两个相同的 root 前后出现在队列中</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">addRootToSchedule</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> expirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Add the root to the schedule.</span>
  <span class="token comment">// Check if this root is already part of the schedule.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>nextScheduledRoot <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This root is not already scheduled. Add it.</span>
    root<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>lastScheduledRoot <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      firstScheduledRoot <span class="token operator">=</span> lastScheduledRoot <span class="token operator">=</span> root<span class="token punctuation">;</span>
      root<span class="token punctuation">.</span>nextScheduledRoot <span class="token operator">=</span> root<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      lastScheduledRoot<span class="token punctuation">.</span>nextScheduledRoot <span class="token operator">=</span> root<span class="token punctuation">;</span>
      lastScheduledRoot <span class="token operator">=</span> root<span class="token punctuation">;</span>
      lastScheduledRoot<span class="token punctuation">.</span>nextScheduledRoot <span class="token operator">=</span> firstScheduledRoot<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// This root is already scheduled, but its priority may have increased.</span>
    <span class="token keyword">var</span> remainingExpirationTime <span class="token operator">=</span> root<span class="token punctuation">.</span>expirationTime<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      remainingExpirationTime <span class="token operator">===</span> NoWork <span class="token operator">||</span>
      expirationTime <span class="token operator">&lt;</span> remainingExpirationTime
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Update the priority.</span>
      root<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>将 root 添加到调度队列中</li></ul></li> <li><p>之后根据 expirationTime 调用 performSyncWork 还是 scheduleCallbackWithExpirationTime</p></li></ul></li> <li><p>scheduleCallbackWithExpirationTime</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">scheduleCallbackWithExpirationTime</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> expirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>callbackExpirationTime <span class="token operator">!==</span> NoWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// A callback is already scheduled. Check its expiration time (timeout).</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>expirationTime <span class="token operator">&gt;</span> callbackExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Existing callback has sufficient timeout. Exit.</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>callbackID <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Existing callback has insufficient timeout. Cancel and schedule a</span>
        <span class="token comment">// new one.</span>
        scheduler<span class="token punctuation">.</span><span class="token function">unstable_cancelCallback</span><span class="token punctuation">(</span>callbackID<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token comment">// The request callback timer is already running. Don't start a new one.</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">startRequestCallbackTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  callbackExpirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
  <span class="token keyword">var</span> currentMs <span class="token operator">=</span> scheduler<span class="token punctuation">.</span><span class="token function">unstable_now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> originalStartTimeMs<span class="token punctuation">;</span>
  <span class="token keyword">var</span> expirationTimeMs <span class="token operator">=</span> <span class="token function">expirationTimeToMs</span><span class="token punctuation">(</span>expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> timeout <span class="token operator">=</span> expirationTimeMs <span class="token operator">-</span> currentMs<span class="token punctuation">;</span>
  callbackID <span class="token operator">=</span> scheduler<span class="token punctuation">.</span><span class="token function">unstable_scheduleCallback</span><span class="token punctuation">(</span>performAsyncWork<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    timeout<span class="token operator">:</span> timeout<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>异步进行 root 任务调度就是通过这个方法来做的</li> <li>计算过期时间</li> <li>传入 performAsyncWork，timeout 超时事件的对象，进入调度</li></ul></li> <li><p>unstable_scheduleCallback</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">unstable_scheduleCallback</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> deprecated_options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> startTime <span class="token operator">=</span> currentEventStartTime <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> currentEventStartTime <span class="token operator">:</span> exports<span class="token punctuation">.</span><span class="token function">unstable_now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> expirationTime<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token keyword">typeof</span> deprecated_options <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span>
    deprecated_options <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
    <span class="token keyword">typeof</span> deprecated_options<span class="token punctuation">.</span>timeout <span class="token operator">===</span> <span class="token string">'number'</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// FIXME: Remove this branch once we lift expiration times out of React.</span>
    expirationTime <span class="token operator">=</span> startTime <span class="token operator">+</span> deprecated_options<span class="token punctuation">.</span>timeout<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 根据currentPriorityLevel 计算 expirationTime</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> newNode <span class="token operator">=</span> <span class="token punctuation">{</span>
    callback<span class="token operator">:</span> callback<span class="token punctuation">,</span>
    priorityLevel<span class="token operator">:</span> currentPriorityLevel<span class="token punctuation">,</span>
    expirationTime<span class="token operator">:</span> expirationTime<span class="token punctuation">,</span>
    next<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    previous<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// Insert the new callback into the list, ordered first by expiration, then</span>
  <span class="token comment">// by insertion. So the new callback is inserted any other callback with</span>
  <span class="token comment">// equal expiration.</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>firstCallbackNode <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This is the first callback in the list.</span>
    firstCallbackNode <span class="token operator">=</span> newNode<span class="token punctuation">.</span>next <span class="token operator">=</span> newNode<span class="token punctuation">.</span>previous <span class="token operator">=</span> newNode<span class="token punctuation">;</span>
    <span class="token function">ensureHostCallbackIsScheduled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// 非首次渲染</span>
  <span class="token punctuation">}</span>

    <span class="token keyword">var</span> previous <span class="token operator">=</span> next<span class="token punctuation">.</span>previous<span class="token punctuation">;</span>
    previous<span class="token punctuation">.</span>next <span class="token operator">=</span> next<span class="token punctuation">.</span>previous <span class="token operator">=</span> newNode<span class="token punctuation">;</span>
    newNode<span class="token punctuation">.</span>next <span class="token operator">=</span> next<span class="token punctuation">;</span>
    newNode<span class="token punctuation">.</span>previous <span class="token operator">=</span> previous<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> newNode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>创建一个调度节点 newNode，并按照 timoutAt 的顺序加入到 CallbackNode 链表</li> <li>expirationTime 是调用时传入的 timeoutAt 加上当前时间形成的过期时间</li></ul></li> <li><p>ensureHostCallbackIsScheduled</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">ensureHostCallbackIsScheduled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isExecutingCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Don't schedule work yet; wait until the next time we yield.</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token comment">// Schedule the host callback using the earliest expiration in the list.</span>

  <span class="token keyword">var</span> expirationTime <span class="token operator">=</span> firstCallbackNode<span class="token punctuation">.</span>expirationTime<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isHostCallbackScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    isHostCallbackScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Cancel the existing host callback.</span>
    <span class="token function">cancelHostCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">_requestHostCallback</span><span class="token punctuation">(</span>flushWork<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p>调度之前判断，判断是否在已经在调度中，如果已经在调度中，直接 return,当前 node 已存在于链表中，会自动进入调度</p></li> <li><p>如果调度没有开始，要将 isHostCallbackScheduled 置为 true</p></li> <li><p>如果已经开始了，要取消，因为</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">_requestHostCallback</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> absoluteTimeout</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  scheduledHostCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
  timeoutTime <span class="token operator">=</span> absoluteTimeout<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isFlushingHostCallback <span class="token operator">||</span> absoluteTimeout <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Don't wait for the next frame. Continue working ASAP, in a new event.</span>
    window<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>messageKey<span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isAnimationFrameScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    isAnimationFrameScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">requestAnimationFrameWithTimeout</span><span class="token punctuation">(</span>animationTick<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p>开始进入调度，设置调度的内容，用 scheduledHostCallback 和 timeoutTime 这两个全局变量记录回调函数和对应的过期时间</p></li> <li><p>如果过期则通过任务队列，将 firstCallbackNode 加入调度队列</p></li> <li><p>如果没过期则进入调度，设置 isAnimationFrameScheduled 为 true,调用 requestAnimationFrameWithTimeout</p></li> <li><p>调用 requestAnimationFrameWithTimeout</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">requestAnimationFrameWithTimeout</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// schedule rAF and also a setTimeout</span>
  rAFID <span class="token operator">=</span> <span class="token function">localRequestAnimationFrame</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">timestamp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// cancel the setTimeout</span>
    <span class="token function">localClearTimeout</span><span class="token punctuation">(</span>rAFTimeoutID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">callback</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  rAFTimeoutID <span class="token operator">=</span> <span class="token function">localSetTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// cancel the requestAnimationFrame</span>
    <span class="token function">localCancelAnimationFrame</span><span class="token punctuation">(</span>rAFID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">callback</span><span class="token punctuation">(</span>exports<span class="token punctuation">.</span><span class="token function">unstable_now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token constant">ANIMATION_FRAME_TIMEOUT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p>这是一个相互取消的操作，如果在 ANIMATION_FRAME_TIMEOUT，requestAnimationFrame 没有执行，则通过定时器执行(?)</p></li> <li><p>animationTick</p> <ul><li><p>通过 requestAnimationFrame 或者定时器加入队列调用</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">animationTick</span><span class="token punctuation">(</span><span class="token parameter">rafTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>scheduledHostCallback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">requestAnimationFrameWithTimeout</span><span class="token punctuation">(</span>animationTick<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// No pending work. Exit.</span>
    isAnimationFrameScheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> nextFrameTime <span class="token operator">=</span> rafTime <span class="token operator">-</span> frameDeadline <span class="token operator">+</span> activeFrameTime<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    nextFrameTime <span class="token operator">&lt;</span> activeFrameTime <span class="token operator">&amp;&amp;</span>
    previousFrameTime <span class="token operator">&lt;</span> activeFrameTime
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextFrameTime <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      nextFrameTime <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    activeFrameTime <span class="token operator">=</span>
      nextFrameTime <span class="token operator">&lt;</span> previousFrameTime
        <span class="token operator">?</span> previousFrameTime
        <span class="token operator">:</span> nextFrameTime<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    previousFrameTime <span class="token operator">=</span> nextFrameTime<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  frameDeadline <span class="token operator">=</span> rafTime <span class="token operator">+</span> activeFrameTime<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isMessageEventScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    isMessageEventScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    window<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>messageKey<span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p>只要 scheduledHostCallback 还在就继续调要</p></li> <li><p>调节帧时间</p> <ul><li>frameDeadline 初始值为 0，activeFrameTime 初始值为 33(即每秒 30 帧，每帧 33 毫秒)</li> <li>首次 frameDeadline 的时间加了初始值的 33 毫秒，利用浏览器的任务队列原理，此刻代码执行完，即将进入浏览器的渲染阶段，即这 33 毫秒，包含了此次渲染的时间</li> <li>因为 animationTick 是通过 requestAnimationFrameWithTimeout 递归调用</li> <li>如果下一次执行的时间小于 activeFrameTime(33 毫秒)，即浏览器的刷新频率大于 30 帧/秒，会进入帧时间调整</li></ul></li> <li><p>通过 postMessage 执行任务队列中的 idleTick</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">idleTick</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>source <span class="token operator">!==</span> window <span class="token operator">||</span> event<span class="token punctuation">.</span>data <span class="token operator">!==</span> messageKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  isMessageEventScheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> prevScheduledCallback <span class="token operator">=</span> scheduledHostCallback<span class="token punctuation">;</span>
  <span class="token keyword">var</span> prevTimeoutTime <span class="token operator">=</span> timeoutTime<span class="token punctuation">;</span>
  scheduledHostCallback <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  timeoutTime <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> currentTime <span class="token operator">=</span> exports<span class="token punctuation">.</span><span class="token function">unstable_now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> didTimeout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>frameDeadline <span class="token operator">-</span> currentTime <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// There's no time left in this idle period. Check if the callback has</span>
    <span class="token comment">// a timeout and whether it's been exceeded.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>prevTimeoutTime <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> prevTimeoutTime <span class="token operator">&lt;=</span> currentTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Exceeded the timeout. Invoke the callback even though there's no</span>
      <span class="token comment">// time left.</span>
      didTimeout <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// No timeout.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isAnimationFrameScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Schedule another animation callback so we retry later.</span>
        isAnimationFrameScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">requestAnimationFrameWithTimeout</span><span class="token punctuation">(</span>animationTick<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token comment">// Exit without invoking the callback.</span>

      scheduledHostCallback <span class="token operator">=</span> prevScheduledCallback<span class="token punctuation">;</span>
      timeoutTime <span class="token operator">=</span> prevTimeoutTime<span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>prevScheduledCallback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    isFlushingHostCallback <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">prevScheduledCallback</span><span class="token punctuation">(</span>didTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      isFlushingHostCallback <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p>首先判断 postMessage 是不是自己的，不是直接返回</p></li> <li><p>获取当前时间，对比 frameDeadline，查看是否已经超时了</p></li> <li><p>如果超时了，判断一下任务 callback 的过期时间有没有到，如果没有到，则重新对这个 callback 进行一次调度，然后返回。如果到了，则设置 didTimeout 为 true</p></li> <li><p>接下去就是调用 callback 了，这里设置 isFlushingHostCallback 全局变量为 true 代表正在执行。并且调用 callback 也就是 flushWork 并传入 didTimeout</p></li> <li><p>进入 flushWork 调用</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">flushWork</span><span class="token punctuation">(</span><span class="token parameter">didTimeout</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  isExecutingCallback <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  deadlineObject<span class="token punctuation">.</span>didTimeout <span class="token operator">=</span> didTimeout<span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>didTimeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Flush all the expired callbacks without yielding.</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>firstCallbackNode <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Read the current time. Flush all the callbacks that expire at or</span>
        <span class="token comment">// earlier than that time. Then read the current time again and repeat.</span>
        <span class="token comment">// This optimizes for as few performance.now calls as possible.</span>
        <span class="token keyword">var</span> currentTime <span class="token operator">=</span> exports<span class="token punctuation">.</span><span class="token function">unstable_now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>firstCallbackNode<span class="token punctuation">.</span>expirationTime <span class="token operator">&lt;=</span> currentTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token function">flushFirstCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>
            firstCallbackNode <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
            firstCallbackNode<span class="token punctuation">.</span>expirationTime <span class="token operator">&lt;=</span> currentTime
          <span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Keep flushing callbacks until we run out of time in the frame.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>firstCallbackNode <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
          <span class="token function">flushFirstCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>
          firstCallbackNode <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
          <span class="token function">getFrameDeadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> exports<span class="token punctuation">.</span><span class="token function">unstable_now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    isExecutingCallback <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>firstCallbackNode <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// There's still work remaining. Request another callback.</span>
      <span class="token function">ensureHostCallbackIsScheduled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      isHostCallbackScheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token comment">// Before exiting, flush all the immediate work that was scheduled.</span>

    <span class="token function">flushImmediateWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p>先设置 isExecutingCallback 为 true，代表正在调用 callback</p></li> <li><p>设置 deadlineObject.didTimeout，在 React 业务中可以用来判断任务是否超时</p></li> <li><p>如果超时，会一次从 firstCallbackNode 向后一直执行，直到第一个没过期的任务</p></li> <li><p>如果没有超时，则依此执行第一个 callback，知道帧时间结束为止</p></li> <li><p>最后清理变量，如果任务没有执行完，则再次调用 ensureHostCallbackIsScheduled 进入调度顺便把 Immedia 优先级的任务都调用一遍。</p></li> <li><p>flushFirstCallback</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">flushFirstCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> flushedNode <span class="token operator">=</span> firstCallbackNode<span class="token punctuation">;</span> <span class="token comment">// Remove the node from the list before calling the callback. That way the</span>
  <span class="token comment">// list is in a consistent state even if the callback throws.</span>

  <span class="token keyword">var</span> next <span class="token operator">=</span> firstCallbackNode<span class="token punctuation">.</span>next<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>firstCallbackNode <span class="token operator">===</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This is the last callback in the list.</span>
    firstCallbackNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> lastCallbackNode <span class="token operator">=</span> firstCallbackNode<span class="token punctuation">.</span>previous<span class="token punctuation">;</span>
    firstCallbackNode <span class="token operator">=</span> lastCallbackNode<span class="token punctuation">.</span>next <span class="token operator">=</span> next<span class="token punctuation">;</span>
    next<span class="token punctuation">.</span>previous <span class="token operator">=</span> lastCallbackNode<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  flushedNode<span class="token punctuation">.</span>next <span class="token operator">=</span> flushedNode<span class="token punctuation">.</span>previous <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// Now it's safe to call the callback.</span>

  <span class="token keyword">var</span> callback <span class="token operator">=</span> flushedNode<span class="token punctuation">.</span>callback<span class="token punctuation">;</span>
  <span class="token keyword">var</span> expirationTime <span class="token operator">=</span> flushedNode<span class="token punctuation">.</span>expirationTime<span class="token punctuation">;</span>
  <span class="token keyword">var</span> priorityLevel <span class="token operator">=</span> flushedNode<span class="token punctuation">.</span>priorityLevel<span class="token punctuation">;</span>
  <span class="token keyword">var</span> previousPriorityLevel <span class="token operator">=</span> currentPriorityLevel<span class="token punctuation">;</span>
  <span class="token keyword">var</span> previousExpirationTime <span class="token operator">=</span> currentExpirationTime<span class="token punctuation">;</span>
  currentPriorityLevel <span class="token operator">=</span> priorityLevel<span class="token punctuation">;</span>
  currentExpirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
  <span class="token keyword">var</span> continuationCallback<span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    continuationCallback <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span>deadlineObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    currentPriorityLevel <span class="token operator">=</span> previousPriorityLevel<span class="token punctuation">;</span>
    currentExpirationTime <span class="token operator">=</span> previousExpirationTime<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token comment">// A callback may return a continuation. The continuation should be scheduled</span>
  <span class="token comment">// with the same priority and expiration as the just-finished callback.</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> continuationCallback <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> continuationNode <span class="token operator">=</span> <span class="token punctuation">{</span>
      callback<span class="token operator">:</span> continuationCallback<span class="token punctuation">,</span>
      priorityLevel<span class="token operator">:</span> priorityLevel<span class="token punctuation">,</span>
      expirationTime<span class="token operator">:</span> expirationTime<span class="token punctuation">,</span>
      next<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      previous<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// Insert the new callback into the list, sorted by its expiration. This is</span>
    <span class="token comment">// almost the same as the code in `scheduleCallback`, except the callback</span>
    <span class="token comment">// is inserted into the list *before* callbacks of equal expiration instead</span>
    <span class="token comment">// of after.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>firstCallbackNode <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// This is the first callback in the list.</span>
      firstCallbackNode <span class="token operator">=</span> continuationNode<span class="token punctuation">.</span>next <span class="token operator">=</span> continuationNode<span class="token punctuation">.</span>previous <span class="token operator">=</span> continuationNode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> nextAfterContinuation <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> node <span class="token operator">=</span> firstCallbackNode<span class="token punctuation">;</span>

      <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>expirationTime <span class="token operator">&gt;=</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// This callback expires at or after the continuation. We will insert</span>
          <span class="token comment">// the continuation *before* this callback.</span>
          nextAfterContinuation <span class="token operator">=</span> node<span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        node <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>node <span class="token operator">!==</span> firstCallbackNode<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>nextAfterContinuation <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// No equal or lower priority callback was found, which means the new</span>
        <span class="token comment">// callback is the lowest priority callback in the list.</span>
        nextAfterContinuation <span class="token operator">=</span> firstCallbackNode<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nextAfterContinuation <span class="token operator">===</span> firstCallbackNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// The new callback is the highest priority callback in the list.</span>
        firstCallbackNode <span class="token operator">=</span> continuationNode<span class="token punctuation">;</span>
        <span class="token function">ensureHostCallbackIsScheduled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">var</span> previous <span class="token operator">=</span> nextAfterContinuation<span class="token punctuation">.</span>previous<span class="token punctuation">;</span>
      previous<span class="token punctuation">.</span>next <span class="token operator">=</span> nextAfterContinuation<span class="token punctuation">.</span>previous <span class="token operator">=</span> continuationNode<span class="token punctuation">;</span>
      continuationNode<span class="token punctuation">.</span>next <span class="token operator">=</span> nextAfterContinuation<span class="token punctuation">;</span>
      continuationNode<span class="token punctuation">.</span>previous <span class="token operator">=</span> previous<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>如果当前队列中只有一个回调，清空队列</li> <li>调用回调并传入 deadline 对象，里面有 timeRemaining 方法通过 frameDeadline - now()来判断是否帧时间已经到了</li> <li>如果回调有返回内容，把这个返回加入到回调队列</li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li> <li><p>performWork</p> <ul><li><p>performWork 通过两种方式调用</p> <ul><li><p>performAsyncWork 异步方式</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">performAsyncWork</span><span class="token punctuation">(</span><span class="token parameter">dl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dl<span class="token punctuation">.</span>didTimeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>firstScheduledRoot <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">recomputeCurrentRendererTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> root <span class="token operator">=</span> firstScheduledRoot<span class="token punctuation">;</span>

      <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token function">didExpireAtExpirationTime</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> currentRendererTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        root <span class="token operator">=</span> root<span class="token punctuation">.</span>nextScheduledRoot<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>root <span class="token operator">!==</span> firstScheduledRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">performWork</span><span class="token punctuation">(</span>NoWork<span class="token punctuation">,</span> dl<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p>如果超时则将该任务的 newExpirationTimeToWorkOn 为当前时间,表示这个任务直接执行就行了，不需要判断是否超过了帧时间</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">didExpireAtExpirationTime</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> currentTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> expirationTime <span class="token operator">=</span> root<span class="token punctuation">.</span>expirationTime<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>expirationTime <span class="token operator">!==</span> NoWork <span class="token operator">&amp;&amp;</span> currentTime <span class="token operator">&gt;=</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// The root has expired. Flush all work up to the current time.</span>
    root<span class="token punctuation">.</span>nextExpirationTimeToWorkOn <span class="token operator">=</span> currentTime<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>给 performWork 设置的 minExpirationTime 是 NoWork</p></li></ul></li> <li><p>performSyncWork 同步方式</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">performSyncWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">performWork</span><span class="token punctuation">(</span>Sync<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>同步方式久比较简单了，设置 minExpirationTime 为 Sync 也就是 1</li></ul></li></ul></li> <li><p>具体 performWork</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">performWork</span><span class="token punctuation">(</span><span class="token parameter">minExpirationTime<span class="token punctuation">,</span> dl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  deadline <span class="token operator">=</span> dl<span class="token punctuation">;</span>

  <span class="token function">findHighestPriorityRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>deadline <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">recomputeCurrentRendererTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    currentSchedulerTime <span class="token operator">=</span> currentRendererTime<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>enableUserTimingAPI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> didExpire <span class="token operator">=</span> nextFlushedExpirationTime <span class="token operator">&lt;</span> currentRendererTime<span class="token punctuation">;</span>
      <span class="token keyword">var</span> timeout <span class="token operator">=</span> <span class="token function">expirationTimeToMs</span><span class="token punctuation">(</span>nextFlushedExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">stopRequestCallbackTimer</span><span class="token punctuation">(</span>didExpire<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>
      nextFlushedRoot <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
      nextFlushedExpirationTime <span class="token operator">!==</span> NoWork <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span>minExpirationTime <span class="token operator">===</span> NoWork <span class="token operator">||</span>
        minExpirationTime <span class="token operator">&gt;=</span> nextFlushedExpirationTime<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span><span class="token operator">!</span>deadlineDidExpire <span class="token operator">||</span>
        currentRendererTime <span class="token operator">&gt;=</span> nextFlushedExpirationTime<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">performWorkOnRoot</span><span class="token punctuation">(</span>
        nextFlushedRoot<span class="token punctuation">,</span>
        nextFlushedExpirationTime<span class="token punctuation">,</span>
        currentRendererTime <span class="token operator">&gt;=</span> nextFlushedExpirationTime
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">findHighestPriorityRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">recomputeCurrentRendererTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      currentSchedulerTime <span class="token operator">=</span> currentRendererTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>
      nextFlushedRoot <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
      nextFlushedExpirationTime <span class="token operator">!==</span> NoWork <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span>minExpirationTime <span class="token operator">===</span> NoWork <span class="token operator">||</span>
        minExpirationTime <span class="token operator">&gt;=</span> nextFlushedExpirationTime<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">performWorkOnRoot</span><span class="token punctuation">(</span>nextFlushedRoot<span class="token punctuation">,</span> nextFlushedExpirationTime<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">findHighestPriorityRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token comment">// We're done flushing work. Either we ran out of time in this callback,</span>
  <span class="token comment">// or there's no more work left with sufficient priority.</span>
  <span class="token comment">// If we're inside a callback, set this to false since we just completed it.</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>deadline <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    callbackExpirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>
    callbackID <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token comment">// If there's work left over, schedule a new callback.</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>nextFlushedExpirationTime <span class="token operator">!==</span> NoWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">scheduleCallbackWithExpirationTime</span><span class="token punctuation">(</span>
      nextFlushedRoot<span class="token punctuation">,</span>
      nextFlushedExpirationTime
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token comment">// Clean-up.</span>

  deadline <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  deadlineDidExpire <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token function">finishRendering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p>设置全局 deadline 对象</p></li> <li><p>通过 findHighestPriorityRoot 找到下一个需要操作的 root，会设置两个全局变量</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">findHighestPriorityRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> highestPriorityWork <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>
  <span class="token keyword">var</span> highestPriorityRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>lastScheduledRoot <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> previousScheduledRoot <span class="token operator">=</span> lastScheduledRoot<span class="token punctuation">;</span>
    <span class="token keyword">var</span> root <span class="token operator">=</span> firstScheduledRoot<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>root <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> remainingExpirationTime <span class="token operator">=</span> root<span class="token punctuation">.</span>expirationTime<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>remainingExpirationTime <span class="token operator">===</span> NoWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">!</span><span class="token punctuation">(</span>previousScheduledRoot <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> lastScheduledRoot <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
          <span class="token operator">?</span> <span class="token function">invariant</span><span class="token punctuation">(</span>
              <span class="token boolean">false</span><span class="token punctuation">,</span>
              <span class="token string">&quot;Should have a previous and last root. This error is likely caused by a bug in React. Please file an issue.&quot;</span>
            <span class="token punctuation">)</span>
          <span class="token operator">:</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">===</span> root<span class="token punctuation">.</span>nextScheduledRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// This is the only root in the list.</span>
          root<span class="token punctuation">.</span>nextScheduledRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
          firstScheduledRoot <span class="token operator">=</span> lastScheduledRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">===</span> firstScheduledRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// This is the first root in the list.</span>
          <span class="token keyword">var</span> next <span class="token operator">=</span> root<span class="token punctuation">.</span>nextScheduledRoot<span class="token punctuation">;</span>
          firstScheduledRoot <span class="token operator">=</span> next<span class="token punctuation">;</span>
          lastScheduledRoot<span class="token punctuation">.</span>nextScheduledRoot <span class="token operator">=</span> next<span class="token punctuation">;</span>
          root<span class="token punctuation">.</span>nextScheduledRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">===</span> lastScheduledRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// This is the last root in the list.</span>
          lastScheduledRoot <span class="token operator">=</span> previousScheduledRoot<span class="token punctuation">;</span>
          lastScheduledRoot<span class="token punctuation">.</span>nextScheduledRoot <span class="token operator">=</span> firstScheduledRoot<span class="token punctuation">;</span>
          root<span class="token punctuation">.</span>nextScheduledRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          previousScheduledRoot<span class="token punctuation">.</span>nextScheduledRoot <span class="token operator">=</span>
            root<span class="token punctuation">.</span>nextScheduledRoot<span class="token punctuation">;</span>
          root<span class="token punctuation">.</span>nextScheduledRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        root <span class="token operator">=</span> previousScheduledRoot<span class="token punctuation">.</span>nextScheduledRoot<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          highestPriorityWork <span class="token operator">===</span> NoWork <span class="token operator">||</span>
          remainingExpirationTime <span class="token operator">&lt;</span> highestPriorityWork
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// Update the priority, if it's higher</span>
          highestPriorityWork <span class="token operator">=</span> remainingExpirationTime<span class="token punctuation">;</span>
          highestPriorityRoot <span class="token operator">=</span> root<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">===</span> lastScheduledRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>highestPriorityWork <span class="token operator">===</span> Sync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// Sync is highest priority by definition so</span>
          <span class="token comment">// we can stop searching.</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        previousScheduledRoot <span class="token operator">=</span> root<span class="token punctuation">;</span>
        root <span class="token operator">=</span> root<span class="token punctuation">.</span>nextScheduledRoot<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  nextFlushedRoot <span class="token operator">=</span> highestPriorityRoot<span class="token punctuation">;</span>
  nextFlushedExpirationTime <span class="token operator">=</span> highestPriorityWork<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>一般情况下我们的 React 应用只会有一个 root，所以这里的大部分逻辑其实都不是常见情况</li> <li>循环 firstScheduledRoot =&gt; lastScheduledRoot，remainingExpirationTime 是 root.expirationTime，也就是最早的过期时间</li> <li>如果他是 NoWork 说明他已经没有任务了，从链表中删除。</li> <li>从剩下的中找到 expirationTime 最小的也就是优先级最高的 root 然后把他赋值给 nextFlushedRoot 并把他的 expirationTime 赋值给 nextFlushedExpirationTime 这两个公共变量。</li></ul></li> <li><p>通过判断是否有 deadline 来分成两种渲染方式，但最大的差距其实是 while 循环的判断条件，有 deadline 的多了一个条件(!deadlineDidExpire || currentRendererTime &gt;= nextFlushedExpirationTime)</p></li> <li><p>performWorkOnRoot</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">performWorkOnRoot</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">,</span> isExpired</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">!</span><span class="token operator">!</span>isRendering
    <span class="token operator">?</span> <span class="token function">invariant</span><span class="token punctuation">(</span>
        <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token string">&quot;performWorkOnRoot was called recursively. This error is likely caused by a bug in React. Please file an issue.&quot;</span>
      <span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
  isRendering <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// Check if this is async work or sync/expired work.</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>deadline <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> isExpired<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Flush work without yielding.</span>
    <span class="token comment">// TODO: Non-yieldy work does not necessarily imply expired work. A renderer</span>
    <span class="token comment">// may want to perform some work without yielding, but also without</span>
    <span class="token comment">// requiring the root to complete (by triggering placeholders).</span>
    <span class="token keyword">var</span> finishedWork <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedWork<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// This root is already complete. We can commit it.</span>
      <span class="token function">completeRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> finishedWork<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      root<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// If this root previously suspended, clear its existing timeout, since</span>
      <span class="token comment">// we're about to try rendering again.</span>

      <span class="token keyword">var</span> timeoutHandle <span class="token operator">=</span> root<span class="token punctuation">.</span>timeoutHandle<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>timeoutHandle <span class="token operator">!==</span> noTimeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        root<span class="token punctuation">.</span>timeoutHandle <span class="token operator">=</span> noTimeout<span class="token punctuation">;</span> <span class="token comment">// $FlowFixMe Complains noTimeout is not a TimeoutID, despite the check above</span>

        <span class="token function">cancelTimeout</span><span class="token punctuation">(</span>timeoutHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">var</span> isYieldy <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token function">renderRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> isYieldy<span class="token punctuation">,</span> isExpired<span class="token punctuation">)</span><span class="token punctuation">;</span>
      finishedWork <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedWork<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// We've completed the root. Commit it.</span>
        <span class="token function">completeRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> finishedWork<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Flush async work.</span>
    <span class="token keyword">var</span> _finishedWork <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedWork<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>_finishedWork <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// This root is already complete. We can commit it.</span>
      <span class="token function">completeRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> _finishedWork<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      root<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// If this root previously suspended, clear its existing timeout, since</span>
      <span class="token comment">// we're about to try rendering again.</span>

      <span class="token keyword">var</span> _timeoutHandle <span class="token operator">=</span> root<span class="token punctuation">.</span>timeoutHandle<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>_timeoutHandle <span class="token operator">!==</span> noTimeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        root<span class="token punctuation">.</span>timeoutHandle <span class="token operator">=</span> noTimeout<span class="token punctuation">;</span> <span class="token comment">// $FlowFixMe Complains noTimeout is not a TimeoutID, despite the check above</span>

        <span class="token function">cancelTimeout</span><span class="token punctuation">(</span>_timeoutHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">var</span> _isYieldy <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token function">renderRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> _isYieldy<span class="token punctuation">,</span> isExpired<span class="token punctuation">)</span><span class="token punctuation">;</span>
      _finishedWork <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedWork<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>_finishedWork <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// We've completed the root. Check the deadline one more time</span>
        <span class="token comment">// before committing.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">shouldYield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// Still time left. Commit the root.</span>
          <span class="token function">completeRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> _finishedWork<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// There's no time left. Mark this root as complete. We'll come</span>
          <span class="token comment">// back and commit it later.</span>
          root<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> _finishedWork<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  isRendering <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>这里也分为同步和异步两种情况，但是这两种情况的区别其实非常小。isYieldy 在同步的情况下是 false，而在异步情况下是 true</li> <li>renderRoot 之后判断一下 shouldYeild，如果时间片已经用完，则不直接 completeRoot，而是等到一下次 requestIdleCallback 之后再执行。</li> <li>renderRoot 渲染阶段和 completeRoot 提交阶段,渲染阶段可以被打断，而提交阶段不能</li></ul></li></ul></li></ul></li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/chttyCode/sys-doc/edit/master/docs/programme/react-source-2.md" target="_blank" rel="noopener noreferrer">编辑此内容</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2021/10/25</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/sys-doc/programme/react-source-1.html" class="prev">
        React 中的更新
      </a></span> <span class="next"><a href="/sys-doc/programme/react-source-3.html">
        各类组件 update
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/sys-doc/assets/js/app.f52ec2a5.js" defer></script><script src="/sys-doc/assets/js/2.01d9652a.js" defer></script><script src="/sys-doc/assets/js/67.7c75e618.js" defer></script>
  </body>
</html>
